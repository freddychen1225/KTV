<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KTV æ™ºæ…§æ’­æ”¾å™¨ (é™„å·¥å…·é€£çµ)</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
      background-color: #121212; color: #e0e0e0;
      margin: 0; padding: 10px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    .container { width: 100%; max-width: 800px; padding-bottom: 80px; }
    
    #video-wrapper {
      position: relative; width: 100%; padding-top: 56.25%;
      background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px;
    }
    video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    .control-panel {
      background: #1e1e1e; padding: 15px; border-radius: 12px; margin-bottom: 15px;
    }
    .btn-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
    
    button {
      padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer;
      font-size: 1rem; font-weight: bold; transition: opacity 0.2s;
    }
    .btn-play { background: #03dac6; color: #000; flex: 2; }
    .btn-vocal { background: #333; color: #fff; border: 1px solid #555; flex: 1; }
    .btn-vocal.active { background: #cf6679; color: #000; border-color: #cf6679; }
    
    .input-group {
      background: #2c2c2c; padding: 12px; border-radius: 8px; margin-bottom: 10px;
    }
    .input-label { display: block; color: #aaa; font-size: 0.85rem; margin-bottom: 5px; }
    input[type="file"] { width: 100%; color: #fff; font-size: 0.9rem; }

    /* å·¥å…·é€£çµå€å¡Šæ¨£å¼ */
    .tools-box {
      display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; margin-bottom: 10px;
    }
    .tool-link {
      text-decoration: none; color: #fff; background: #444;
      padding: 6px 12px; border-radius: 4px; font-size: 0.8rem;
      display: inline-flex; align-items: center; gap: 4px;
    }
    .tool-link:hover { background: #555; }
    .tool-rec { background: #2e7d32; } /* æ¨è–¦è‰² */

    #playlist { list-style: none; padding: 0; margin: 0; }
    .playlist-item {
      background: #252525; margin-bottom: 8px; padding: 12px; border-radius: 8px;
      display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }
    .playlist-item.playing { background: #333; border-left: 4px solid #03dac6; }
    .item-info { flex-grow: 1; overflow: hidden; }
    .item-title { display: block; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-match-info { font-size: 0.75rem; color: #aaa; margin-top: 4px; }
    .match-success { color: #4caf50; }
    .match-none { color: #ff9800; }
    .btn-del { background: none; color: #666; font-size: 1.2rem; padding: 0 8px; }
  </style>
</head>
<body>

<div class="container">
  <h2 style="text-align: center; color: #bb86fc; margin: 10px 0;">KTV æ™ºæ…§æ’­æ”¾å™¨</h2>

  <div id="video-wrapper">
    <video id="mainVideo" controls playsinline webkit-playsinline></video>
  </div>
  <audio id="extAudio"></audio>

  <div class="control-panel">
    <div class="btn-row">
      <button id="playBtn" class="btn-play">â–¶ æ’­æ”¾ / æš«åœ</button>
      <button id="vocalBtn" class="btn-vocal">å»äººè²</button>
    </div>
    <div style="text-align: center; color: #888; font-size: 0.9rem;" id="status-text">
      è«‹åŒ¯å…¥æ­Œæ›²
    </div>
  </div>

  <!-- æ‰¹æ¬¡åŒ¯å…¥å€ -->
  <div class="control-panel">
    <h3 style="margin: 0 0 10px 0; font-size: 1rem; color: #fff;">ğŸ“‚ æ‰¹æ¬¡åŒ¯å…¥èˆ‡è‡ªå‹•é…å°</h3>
    
    <!-- å·¥å…·é€£çµå€ -->
    <div style="background: #333; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
      <span style="font-size: 0.85rem; color: #ccc; display: block; margin-bottom: 8px;">ğŸ› ï¸ å…è²»ç·šä¸Šè£½ä½œå‡é™ Key éŸ³æª” (MP3)ï¼š</span>
      <div class="tools-box">
        <a href="https://vocalremover.org/pitch" target="_blank" class="tool-link tool-rec">
          â˜… VocalRemover (æ¨è–¦) â†—
        </a>
        <a href="https://app.musicspeedchanger.com/" target="_blank" class="tool-link">
          Music Speed Changer â†—
        </a>
        <a href="https://mp3cut.net/change-pitch" target="_blank" class="tool-link">
          MP3Cut â†—
        </a>
      </div>
      <div style="font-size: 0.75rem; color: #888;">
        æ“ä½œæç¤ºï¼šä¸Šå‚³å½±ç‰‡ â†’ èª¿æ•´ Key (Semitones) â†’ ä¸‹è¼‰ MP3 â†’ åœ¨ä¸‹æ–¹ã€Œé¸æ“‡éŸ³è¨Šæª”ã€åŒ¯å…¥
      </div>
    </div>
    
    <div class="input-group">
      <span class="input-label">1. é¸æ“‡å½±ç‰‡æª” (MP4) - å¤šé¸</span>
      <input type="file" id="videoInput" accept="video/*" multiple>
    </div>
    
    <div class="input-group">
      <span class="input-label">2. é¸æ“‡éŸ³è¨Šæª” (MP3/WAV) - å¤šé¸</span>
      <input type="file" id="audioInput" accept="audio/*" multiple>
    </div>

    <button onclick="batchImport()" style="width: 100%; background: #444; color: white;">é–‹å§‹æ™ºæ…§é…å°ä¸¦åŠ å…¥æ¸…å–®</button>
  </div>

  <ul id="playlist"></ul>
</div>

<script>
  // DOM Elements
  const mainVideo = document.getElementById('mainVideo');
  const extAudio = document.getElementById('extAudio');
  const playBtn = document.getElementById('playBtn');
  const vocalBtn = document.getElementById('vocalBtn');
  const statusText = document.getElementById('status-text');
  const playlistEl = document.getElementById('playlist');
  const videoInput = document.getElementById('videoInput');
  const audioInput = document.getElementById('audioInput');

  // State
  let playlist = [];
  let currentIndex = -1;
  let isPlaying = false;
  let isVocalRemove = false;
  let syncInterval;

  // AudioContext
  let audioCtx, sourceNode, splitter, merger, inverter;

  function initAudio() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  function setupAudioRouting() {
    initAudio();
    if (sourceNode) sourceNode.disconnect();
    else sourceNode = audioCtx.createMediaElementSource(extAudio);

    if (isVocalRemove) {
      if (!splitter) splitter = audioCtx.createChannelSplitter(2);
      if (!merger) merger = audioCtx.createChannelMerger(2);
      if (!inverter) { inverter = audioCtx.createGain(); inverter.gain.value = -1; }

      sourceNode.connect(splitter);
      splitter.connect(merger, 0, 0);
      splitter.connect(inverter, 1);
      inverter.connect(merger, 0, 0);
      splitter.connect(merger, 0, 1);
      inverter.connect(merger, 0, 1);

      merger.connect(audioCtx.destination);
    } else {
      sourceNode.connect(audioCtx.destination);
    }
  }

  // Playback Logic
  playBtn.addEventListener('click', () => {
    if (currentIndex === -1) return alert("æ¸…å–®æ˜¯ç©ºçš„ï¼");
    if (mainVideo.paused) mainVideo.play();
    else mainVideo.pause();
  });

  mainVideo.addEventListener('play', () => {
    initAudio();
    extAudio.play();
    isPlaying = true;
    playBtn.textContent = "â¸ æš«åœ";
    startSync();
    setupAudioRouting();
  });

  mainVideo.addEventListener('pause', () => {
    extAudio.pause();
    isPlaying = false;
    playBtn.textContent = "â–¶ æ’­æ”¾";
    stopSync();
  });

  mainVideo.addEventListener('seeked', () => {
    extAudio.currentTime = mainVideo.currentTime;
    if (!mainVideo.paused) extAudio.play();
  });

  function startSync() {
    stopSync();
    syncInterval = setInterval(() => {
      if (mainVideo.paused) return;
      const diff = Math.abs(mainVideo.currentTime - extAudio.currentTime);
      if (diff > 0.2) extAudio.currentTime = mainVideo.currentTime;
    }, 500);
  }

  function stopSync() {
    if (syncInterval) clearInterval(syncInterval);
  }

  // Batch Import
  function getFileName(file) {
    return file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
  }

  function batchImport() {
    const vFiles = Array.from(videoInput.files);
    const aFiles = Array.from(audioInput.files);

    if (vFiles.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡å½±ç‰‡æª”ï¼");

    const audioMap = new Map();
    aFiles.forEach(f => audioMap.set(getFileName(f), f));

    let addedCount = 0;
    vFiles.forEach(vFile => {
      const baseName = getFileName(vFile);
      const matchedAudio = audioMap.get(baseName);
      const audioSource = matchedAudio ? matchedAudio : vFile;
      
      playlist.push({
        title: baseName,
        videoUrl: URL.createObjectURL(vFile),
        audioUrl: URL.createObjectURL(audioSource),
        isMatch: !!matchedAudio
      });
      addedCount++;
    });

    renderPlaylist();
    videoInput.value = '';
    audioInput.value = '';

    if (addedCount > 0) {
      if (currentIndex === -1) playIndex(0);
    }
  }

  function renderPlaylist() {
    playlistEl.innerHTML = '';
    playlist.forEach((item, idx) => {
      const li = document.createElement('li');
      li.className = `playlist-item ${idx === currentIndex ? 'playing' : ''}`;
      const matchText = item.isMatch 
        ? `<span class="item-match-info match-success">â˜… æ™ºæ…§é…å°æˆåŠŸ</span>`
        : `<span class="item-match-info match-none">åŸéŸ³æ’­æ”¾</span>`;

      li.innerHTML = `
        <div class="item-info" onclick="playIndex(${idx})">
          <span class="item-title">${idx+1}. ${item.title}</span>
          ${matchText}
        </div>
        <button class="btn-del" onclick="delIndex(${idx})">Ã—</button>
      `;
      playlistEl.appendChild(li);
    });
  }

  function playIndex(idx) {
    if (idx < 0 || idx >= playlist.length) return;
    currentIndex = idx;
    const item = playlist[idx];

    mainVideo.src = item.videoUrl;
    extAudio.src = item.audioUrl;
    mainVideo.muted = true;

    statusText.textContent = `æ­£åœ¨æ’­æ”¾: ${item.title}`;
    mainVideo.play().catch(e => console.log(e));
    renderPlaylist();
  }

  function delIndex(idx) {
    playlist.splice(idx, 1);
    if (currentIndex === idx) {
      mainVideo.pause();
      currentIndex = -1;
      statusText.textContent = "åœæ­¢æ’­æ”¾";
    } else if (currentIndex > idx) currentIndex--;
    renderPlaylist();
  }

  vocalBtn.addEventListener('click', () => {
    isVocalRemove = !isVocalRemove;
    vocalBtn.classList.toggle('active');
    if (currentIndex !== -1) setupAudioRouting();
  });

  new Sortable(playlistEl, {
    animation: 150,
    onEnd: (evt) => {
      const item = playlist.splice(evt.oldIndex, 1)[0];
      playlist.splice(evt.newIndex, 0, item);
      if (currentIndex === evt.oldIndex) currentIndex = evt.newIndex;
      renderPlaylist();
    }
  });
  
  mainVideo.addEventListener('ended', () => {
    if (currentIndex < playlist.length - 1) playIndex(currentIndex + 1);
  });
</script>
</body>
</html>
