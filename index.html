<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¤ å°ˆæ¥­ KTV Web App - ç´”éŸ³é«˜å‡é™ Key</title>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; padding: 20px; min-height: 100vh;
    }
    .container {
      max-width: 900px; margin: 0 auto; background: white;
      border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #ff6b6b, #feca57); color: white;
      padding: 30px; text-align: center;
    }
    .content { padding: 30px; }
    .upload-area {
      border: 3px dashed #ddd; border-radius: 15px; padding: 40px;
      text-align: center; cursor: pointer; transition: all 0.3s;
      margin-bottom: 20px;
    }
    .upload-area:hover { border-color: #667eea; background: #f8f9ff; }
    .upload-area.dragover { border-color: #667eea; background: #e3f2fd; }
    #fileInput { display: none; }
    .controls {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px; margin: 20px 0;
    }
    .pitch-btn {
      padding: 15px 10px; border: none; border-radius: 12px;
      font-size: 16px; font-weight: bold; cursor: pointer;
      transition: all 0.3s; color: white;
    }
    .pitch-up { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
    .pitch-down { background: linear-gradient(45deg, #ff6b6b, #ee5a52); }
    .pitch-up:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(78,205,196,0.4); }
    .pitch-down:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,107,107,0.4); }
    .vocal-btn { 
      grid-column: span 2; background: linear-gradient(45deg, #a8e6cf, #88d8a3);
      padding: 15px; border-radius: 12px; border: none; font-size: 16px;
    }
    #video-container {
      background: #000; border-radius: 15px; margin: 20px 0;
      overflow: hidden; aspect-ratio: 16/9;
    }
    video { width: 100%; height: 100%; }
    .status {
      padding: 15px; border-radius: 10px; margin: 15px 0;
      font-weight: bold; text-align: center;
    }
    .loading { background: #fff3cd; color: #856404; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .progress { background: #e3f2fd; color: #0c5460; }
    #playlist {
      background: #f8f9fa; border-radius: 10px; padding: 15px;
      max-height: 200px; overflow-y: auto;
    }
    .playlist-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px; margin: 5px 0; background: white;
      border-radius: 8px; cursor: pointer;
    }
    .playlist-item:hover { background: #e3f2fd; }
    .playlist-item.playing { background: #4ecdc4; color: white; }
    .delete-btn { 
      background: #ff4757; color: white; border: none;
      border-radius: 50%; width: 25px; height: 25px; cursor: pointer;
    }
    @media (max-width: 768px) {
      .controls { grid-template-columns: 1fr 1fr; }
      .vocal-btn { grid-column: span 2; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ¤ å°ˆæ¥­ KTV æ’­æ”¾å™¨</h1>
    <p>ä¸Šå‚³å½±ç‰‡ â†’ ä¸€éµå‡é™ Key â†’ é«˜å“è³ªæ’­æ”¾</p>
  </div>

  <div class="content">
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
      <div>ğŸ“ é»æ“Šé¸æ“‡å½±ç‰‡æª”æ¡ˆ</div>
      <div style="font-size: 14px; margin-top: 10px; color: #666;">
        æ”¯æ´ MP4ã€MOVã€WebM (æœ€å¤§ 100MB)
      </div>
      <input type="file" id="fileInput" accept="video/*">
    </div>

    <div class="controls">
      <button class="pitch-btn pitch-up" onclick="processPitch(2)">+2 Key</button>
      <button class="pitch-btn pitch-up" onclick="processPitch(1)">+1 Key</button>
      <button class="pitch-btn pitch-down" onclick="processPitch(-1)">-1 Key</button>
      <button class="pitch-btn pitch-down" onclick="processPitch(-2)">-2 Key</button>
      <button class="vocal-btn" id="vocalBtn" onclick="toggleVocalRemove()">ğŸµ å•Ÿç”¨å»äººè²</button>
      <button class="pitch-btn" style="background: #6c757d;" onclick="playOriginal()">åŸç‰ˆæ’­æ”¾</button>
    </div>

    <div id="status" class="status">æº–å‚™å°±ç·’ï¼Œè«‹é¸æ“‡å½±ç‰‡æª”æ¡ˆ</div>

    <div id="video-container">
      <video id="player" controls playsinline webkit-playsinline></video>
    </div>

    <div id="playlist"></div>
  </div>
</div>

<script>
const { FFmpeg } = FFmpegWASM;
const ffmpeg = new FFmpeg();
const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';

let originalVideoBlob;
let processedVideos = new Map(); // key: pitch value, value: processed blob
let currentPitch = 0;
let isVocalRemove = false;
let playlist = [];

ffmpeg.on('log', ({ message }) => {
  console.log(message);
});

ffmpeg.on('progress', ({ progress }) => {
  document.getElementById('status').innerHTML = 
    `è™•ç†ä¸­... ${Math.round(progress * 100)}%`;
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file && file.size < 100 * 1024 * 1024) { // 100MB limit
    originalVideoBlob = file;
    playlist = [{ name: file.name, blob: file }];
    currentPitch = 0;
    updateStatus('å½±ç‰‡å·²é¸æ“‡ï¼é»æ“Šå‡é™ Key æŒ‰éˆ•é–‹å§‹è™•ç†...', 'progress');
    renderPlaylist();
  } else {
    alert('æª”æ¡ˆéå¤§ (æœ€å¤§ 100MB) æˆ–æ ¼å¼ä¸æ”¯æ´');
  }
});

async function processPitch(semitones) {
  if (!originalVideoBlob) {
    alert('è«‹å…ˆé¸æ“‡å½±ç‰‡');
    return;
  }

  const key = semitones;
  if (processedVideos.has(key)) {
    playProcessedVideo(key);
    return;
  }

  updateStatus('æ­£åœ¨æŠ½å–éŸ³è¨Š...', 'loading');
  
  try {
    // 1. åˆå§‹åŒ– FFmpeg
    if (!ffmpeg.loaded) {
      await ffmpeg.load({
        coreURL: await getCoreURL(baseURL, 'avcodec'),
        wasmURL: await getCoreURL(baseURL, 'wasm')
      });
    }

    // 2. å¯«å…¥åŸå§‹å½±ç‰‡
    await ffmpeg.writeFile('input.mp4', await fetchFile(originalVideoBlob));

    // 3. æŠ½å–éŸ³è¨Š
    updateStatus('æŠ½å–éŸ³è¨Šå®Œæˆï¼Œæ­£åœ¨ç·šä¸Šå‡é™ Key...', 'loading');
    await ffmpeg.exec(['-i', 'input.mp4', '-vn', '-acodec', 'mp3', 'audio.mp3']);
    const audioData = await ffmpeg.readFile('audio.mp3');

    // 4. ç·šä¸Šå‡é™ Key è™•ç† (ä½¿ç”¨ vocalremover.org)
    const processedAudio = await pitchShiftOnline(audioData, semitones);
    
    // 5. å¯«å›è™•ç†å¾ŒéŸ³è¨Š
    await ffmpeg.writeFile('processed.mp3', processedAudio);

    // 6. é‡æ–°åˆæˆå½±ç‰‡ + è™•ç†éŸ³è¨Š
    updateStatus('åˆæˆå½±ç‰‡ä¸­...', 'loading');
    await ffmpeg.exec([
      '-i', 'input.mp4', '-i', 'processed.mp3',
      '-c:v', 'copy', '-c:a', 'aac', '-map', '0:v:0', '-map', '1:a:0',
      'output.mp4'
    ]);

    // 7. è®€å–æœ€çµ‚å½±ç‰‡
    const finalVideo = await ffmpeg.readFile('output.mp4');
    const finalBlob = new Blob([finalVideo.buffer], { type: 'video/mp4' });
    
    processedVideos.set(key, finalBlob);
    playProcessedVideo(key);
    updateStatus(`âœ… å‡é™ Key ${semitones > 0 ? '+' : ''}${semitones} å®Œæˆï¼`, 'success');

  } catch (error) {
    console.error(error);
    updateStatus('âŒ è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
  }
}

async function pitchShiftOnline(audioData, semitones) {
  // ä½¿ç”¨ vocalremover.org çš„ pitch shifter API
  const formData = new FormData();
  formData.append('audio', new Blob([audioData], { type: 'audio/mp3' }), 'audio.mp3');
  
  // æ³¨æ„ï¼šé€™æ˜¯ç¤ºæ„ endpointï¼Œå¯¦éš›ä½¿ç”¨éœ€ç¢ºèªæœå‹™ API
  const response = await fetch('https://vocalremover.org/api/pitch', {
    method: 'POST',
    body: formData
  });
  
  if (!response.ok) {
    throw new Error('ç·šä¸Šå‡é™ Key æœå‹™æš«ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°è™•ç†');
  }
  
  return await response.arrayBuffer();
}

async function getCoreURL(baseURL, file) {
  const result = await fetch(`${baseURL}/${file}.data`, { headers: { 'Content-Type': 'application/octet-stream' } });
  const data = await result.arrayBuffer();
  return URL.createObjectURL(new Blob([data]));
}

async function fetchFile(file) {
  return new Uint8Array(await file.arrayBuffer());
}

function playProcessedVideo(pitch) {
  const video = document.getElementById('player');
  const blob = processedVideos.get(pitch) || originalVideoBlob;
  video.src = URL.createObjectURL(blob);
  video.play();
  currentPitch = pitch;
}

function playOriginal() {
  const video = document.getElementById('player');
  if (originalVideoBlob) {
    video.src = URL.createObjectURL(originalVideoBlob);
    video.play();
    currentPitch = 0;
  }
}

function toggleVocalRemove() {
  isVocalRemove = !isVocalRemove;
  const btn = document.getElementById('vocalBtn');
  btn.textContent = isVocalRemove ? 'ğŸµ é—œé–‰å»äººè²' : 'ğŸµ å•Ÿç”¨å»äººè²';
  btn.style.background = isVocalRemove ? 
    'linear-gradient(45deg, #ff9a9e, #fecfef)' : 
    'linear-gradient(45deg, #a8e6cf, #88d8a3)';
}

function updateStatus(message, type) {
  const el = document.getElementById('status');
  el.textContent = message;
  el.className = `status ${type}`;
}

function renderPlaylist() {
  const playlistEl = document.getElementById('playlist');
  playlistEl.innerHTML = `
    <div style="font-weight: bold; margin-bottom: 10px;">
      æ’­æ”¾æ¸…å–® (${playlist.length} é¦–)
    </div>
    ${playlist.map((item, index) => `
      <div class="playlist-item ${index === 0 && currentPitch === 0 ? 'playing' : ''}"
           onclick="playPlaylistItem(${index})">
        <span>${item.name}</span>
        <button class="delete-btn" onclick="deletePlaylistItem(${index}); event.stopPropagation()">Ã—</button>
      </div>
    `).join('')}
  `;
}

function playPlaylistItem(index) {
  // ç°¡åŒ–ï¼šç›®å‰åªæ”¯æ´å–®ä¸€å½±ç‰‡ï¼Œå¯æ“´å±•
}

function deletePlaylistItem(index) {
  playlist.splice(index, 1);
  renderPlaylist();
}

// Drag & Drop æ”¯æ´
const uploadArea = document.querySelector('.upload-area');
uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});
uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  document.getElementById('fileInput').files = e.dataTransfer.files;
  document.getElementById('fileInput').dispatchEvent(new Event('change'));
});
</script>
</body>
</html>
