<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KTV å½±éŸ³åŒæ­¥æ’­æ”¾å™¨ (MVæ¨¡å¼)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0; padding: 10px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    .container { width: 100%; max-width: 800px; padding-bottom: 50px;}
    
    /* å½±ç‰‡å€å¡Š */
    #video-wrapper {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 */
      background: #111;
      margin-bottom: 15px;
    }
    video {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    }

    /* æ­¥é©Ÿå¼•å° */
    .step-card {
      background: #222; border: 1px solid #333; border-radius: 8px;
      padding: 15px; margin-bottom: 15px;
    }
    .step-title { color: #4caf50; font-weight: bold; margin-bottom: 8px; display: block;}
    .tool-btn {
      display: inline-block; background: #2196f3; color: white; text-decoration: none;
      padding: 8px 16px; border-radius: 4px; font-size: 0.9rem; margin-top: 5px;
    }

    /* æ§åˆ¶å€ */
    .control-row {
      display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;
    }
    .file-group {
      background: #333; padding: 10px; border-radius: 8px;
    }
    .file-label { font-size: 0.85rem; color: #aaa; margin-bottom: 5px; display: block;}
    input[type="file"] { width: 100%; font-size: 0.9rem; color: #fff;}
    
    /* åŒæ­¥ç‹€æ…‹ */
    #sync-status {
      text-align: center; font-size: 0.9rem; color: #ff9800; margin-bottom: 10px;
      height: 20px;
    }

    /* æ’­æ”¾æ§åˆ¶ */
    .main-controls {
      display: flex; gap: 10px; justify-content: center;
    }
    button.play-btn {
      background: #e91e63; color: white; border: none; padding: 10px 30px;
      border-radius: 25px; font-size: 1.1rem; cursor: pointer;
    }
    button.reset-btn {
      background: #555; color: white; border: none; padding: 10px;
      border-radius: 8px; cursor: pointer;
    }

  </style>
</head>
<body>

<div class="container">
  <h2 style="text-align: center; margin-top: 0;">ğŸ¤ KTV å½±éŸ³åŒæ­¥ç‰ˆ</h2>

  <div id="video-wrapper">
    <!-- é€™æ˜¯åŸæœ¬çš„å½±ç‰‡ (æˆ‘å€‘æœƒæŠŠå®ƒçš„è²éŸ³éœéŸ³) -->
    <video id="mainVideo" playsinline webkit-playsinline></video>
  </div>
  
  <!-- é€™æ˜¯å¤–éƒ¨è™•ç†å¥½çš„éŸ³æª” (éš±è—æ’­æ”¾ï¼Œæˆ‘å€‘åªè½å®ƒçš„è²éŸ³) -->
  <audio id="extAudio"></audio>

  <div id="sync-status"></div>

  <div class="main-controls">
    <button class="play-btn" id="playToggle">â–¶ æ’­æ”¾ / æš«åœ</button>
    <button class="reset-btn" onclick="location.reload()">é‡ç½®</button>
  </div>

  <hr style="border-color: #333; margin: 20px 0;">

  <!-- æ­¥é©Ÿ 1 -->
  <div class="step-card">
    <span class="step-title">æ­¥é©Ÿ 1ï¼šæº–å‚™ç´ æ</span>
    <div style="font-size: 0.9rem; color: #ccc;">
      1. æº–å‚™ä½ çš„ <b>MV å½±ç‰‡æª”</b> (MP4)ã€‚<br>
      2. å» <a href="https://vocalremover.org/pitch" target="_blank" style="color:#2196f3">VocalRemover</a> ä¸Šå‚³å½±ç‰‡ï¼Œèª¿æ•´ Keyï¼Œä¸‹è¼‰ <b>è™•ç†å¾Œçš„ MP3</b>ã€‚
    </div>
  </div>

  <!-- æ­¥é©Ÿ 2 -->
  <div class="step-card">
    <span class="step-title">æ­¥é©Ÿ 2ï¼šè¼‰å…¥æª”æ¡ˆ (å½±éŸ³åˆé«”)</span>
    <div class="control-row">
      <div class="file-group">
        <span class="file-label">1. é¸æ“‡åŸå§‹ MV å½±ç‰‡ (å½±åƒç”¨)</span>
        <input type="file" id="videoInput" accept="video/*">
      </div>
      <div class="file-group">
        <span class="file-label">2. é¸æ“‡è™•ç†å¾Œçš„ MP3 (è²éŸ³ç”¨)</span>
        <input type="file" id="audioInput" accept="audio/*">
      </div>
    </div>
  </div>

</div>

<script>
  const videoInput = document.getElementById('videoInput');
  const audioInput = document.getElementById('audioInput');
  const video = document.getElementById('mainVideo');
  const audio = document.getElementById('extAudio');
  const playBtn = document.getElementById('playToggle');
  const status = document.getElementById('sync-status');

  let isVideoReady = false;
  let isAudioReady = false;
  let syncInterval;

  // 1. è¼‰å…¥å½±ç‰‡
  videoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      video.src = URL.createObjectURL(file);
      // é‡è¦ï¼šæŠŠå½±ç‰‡éœéŸ³ï¼Œé€™æ¨£æ‰ä¸æœƒè½åˆ°åŸèª¿çš„è²éŸ³å’Œå‡é™èª¿çš„è²éŸ³æ‰“æ¶
      video.muted = true; 
      isVideoReady = true;
      checkReady();
    }
  });

  // 2. è¼‰å…¥éŸ³æª”
  audioInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      audio.src = URL.createObjectURL(file);
      isAudioReady = true;
      checkReady();
    }
  });

  function checkReady() {
    if (isVideoReady && isAudioReady) {
      status.textContent = "âœ… å½±éŸ³çš†å·²å°±ç·’ï¼ŒåŒæ­¥æ¨¡å¼å•Ÿå‹•ï¼";
      status.style.color = "#4caf50";
    } else if (isVideoReady) {
      status.textContent = "âš ï¸ ç­‰å¾…è¼‰å…¥ MP3 éŸ³æª”...";
    }
  }

  // 3. åŒæ­¥æ§åˆ¶é‚è¼¯
  playBtn.addEventListener('click', togglePlay);

  function togglePlay() {
    if (!isVideoReady) return alert("è«‹å…ˆè¼‰å…¥å½±ç‰‡ï¼");
    
    // å¦‚æœåªæœ‰å½±ç‰‡æ²’æœ‰MP3ï¼Œå°±ç•¶ä½œæ™®é€šæ’­æ”¾å™¨ç”¨
    if (!isAudioReady) {
      video.muted = false; // æ¢å¾©å½±ç‰‡è²éŸ³
      if (video.paused) {
        video.play();
        playBtn.textContent = "â¸ æš«åœ";
      } else {
        video.pause();
        playBtn.textContent = "â–¶ æ’­æ”¾";
      }
      return;
    }

    // å½±éŸ³åŒæ­¥æ¨¡å¼
    if (video.paused) {
      // é–‹å§‹æ’­æ”¾
      const startPromise = video.play();
      if (startPromise !== undefined) {
        startPromise.then(() => {
          // å½±ç‰‡é–‹å§‹å¾Œï¼Œç«‹åˆ»è®“éŸ³è¨Šè·Ÿä¸Š
          audio.currentTime = video.currentTime;
          audio.play();
          startSyncCheck(); // å•Ÿå‹•æ ¡æ­£
          playBtn.textContent = "â¸ æš«åœ";
        }).catch(error => console.log("æ’­æ”¾è¢«é˜»æ“‹", error));
      }
    } else {
      // æš«åœ
      video.pause();
      audio.pause();
      stopSyncCheck();
      playBtn.textContent = "â–¶ æ’­æ”¾";
    }
  }

  // 4. é€²åº¦æ¢æ‹–å‹•åŒæ­¥
  // ç•¶ä½¿ç”¨è€…æ‹‰å‹•å½±ç‰‡é€²åº¦æ¢ (native controls)
  video.addEventListener('seeked', () => {
    if (isAudioReady) {
      audio.currentTime = video.currentTime;
    }
  });
  
  video.addEventListener('seeking', () => {
    if (isAudioReady && !audio.paused) {
      audio.pause(); // æ‹–å‹•æ™‚å…ˆæš«åœè²éŸ³é¿å…é›œéŸ³
    }
  });

  // 5. è‡ªå‹•æ ¡æ­£æ©Ÿåˆ¶ (æ¯ 0.5 ç§’æª¢æŸ¥ä¸€æ¬¡)
  // å¦‚æœå½±ç‰‡å’Œè²éŸ³èª¤å·®è¶…é 0.1 ç§’ï¼Œå¼·åˆ¶æŠŠè²éŸ³æ‹‰å›ä¾†
  function startSyncCheck() {
    stopSyncCheck();
    syncInterval = setInterval(() => {
      if (!isAudioReady || video.paused) return;
      
      const diff = Math.abs(video.currentTime - audio.currentTime);
      if (diff > 0.1) {
        // console.log(`æ ¡æ­£åŒæ­¥ï¼šèª¤å·® ${diff}ç§’`);
        audio.currentTime = video.currentTime;
      }
    }, 500);
  }

  function stopSyncCheck() {
    if (syncInterval) clearInterval(syncInterval);
  }

  // å½±ç‰‡æ’­å®Œ
  video.addEventListener('ended', () => {
    audio.pause();
    audio.currentTime = 0;
    playBtn.textContent = "â–¶ é‡æ’­";
    stopSyncCheck();
  });

</script>

</body>
</html>
