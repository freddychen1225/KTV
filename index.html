<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KTV æ™ºæ…§æ’­æ”¾å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
      background-color: #121212; color: #e0e0e0;
      margin: 0; padding: 10px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    .container { width: 100%; max-width: 800px; padding-bottom: 80px; }
    
    #video-wrapper {
      position: relative; width: 100%; padding-top: 56.25%;
      background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px;
    }
    /* é‡è¦ï¼šé–‹å•ŸåŸç”Ÿ controls */
    video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    .control-panel {
      background: #1e1e1e; padding: 15px; border-radius: 12px; margin-bottom: 15px;
    }
    .btn-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
    
    button {
      padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer;
      font-size: 1rem; font-weight: bold; transition: opacity 0.2s;
    }
    .btn-play { background: #03dac6; color: #000; flex: 2; }
    .btn-vocal { background: #333; color: #fff; border: 1px solid #555; flex: 1; }
    .btn-vocal.active { background: #cf6679; color: #000; border-color: #cf6679; }
    
    .input-group {
      background: #2c2c2c; padding: 12px; border-radius: 8px; margin-bottom: 10px;
    }
    .input-label { display: block; color: #aaa; font-size: 0.85rem; margin-bottom: 5px; }
    input[type="file"] { width: 100%; color: #fff; font-size: 0.9rem; }

    #playlist { list-style: none; padding: 0; margin: 0; }
    .playlist-item {
      background: #252525; margin-bottom: 8px; padding: 12px; border-radius: 8px;
      display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }
    .playlist-item.playing { background: #333; border-left: 4px solid #03dac6; }
    .item-info { flex-grow: 1; overflow: hidden; }
    .item-title { display: block; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-match-info { font-size: 0.75rem; color: #aaa; margin-top: 4px; }
    .match-success { color: #4caf50; }
    .match-none { color: #ff9800; }
    .btn-del { background: none; color: #666; font-size: 1.2rem; padding: 0 8px; }
  </style>
</head>
<body>

<div class="container">
  <h2 style="text-align: center; color: #bb86fc; margin: 10px 0;">KTV æ™ºæ…§æ’­æ”¾å™¨</h2>

  <!-- æ’­æ”¾å™¨ï¼šä¸€å®šè¦åŠ  controls è®“ä½ å¯ä»¥æ‹‰é€²åº¦æ¢ -->
  <div id="video-wrapper">
    <video id="mainVideo" controls playsinline webkit-playsinline></video>
  </div>
  <audio id="extAudio"></audio>

  <!-- æ§åˆ¶é¢æ¿ -->
  <div class="control-panel">
    <div class="btn-row">
      <button id="playBtn" class="btn-play">â–¶ æ’­æ”¾ / æš«åœ</button>
      <button id="vocalBtn" class="btn-vocal">å»äººè²</button>
    </div>
    <div style="text-align: center; color: #888; font-size: 0.9rem;" id="status-text">
      è«‹åŒ¯å…¥æ­Œæ›²
    </div>
  </div>

  <!-- æ‰¹æ¬¡åŒ¯å…¥å€ -->
  <div class="control-panel">
    <h3 style="margin: 0 0 10px 0; font-size: 1rem; color: #fff;">ğŸ“‚ æ‰¹æ¬¡åŒ¯å…¥èˆ‡è‡ªå‹•é…å°</h3>
    <div style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">
      ç³»çµ±æœƒè‡ªå‹•æ ¹æ“šã€Œä¸»æª”åã€å°‡å½±ç‰‡èˆ‡éŸ³æª”é…å°ã€‚<br>
      ä¾‹å¦‚ï¼šde>song1.mp4</code> æœƒè‡ªå‹•é…å° de>song1.mp3</code>
    </div>
    
    <div class="input-group">
      <span class="input-label">1. é¸æ“‡å¤šå€‹å½±ç‰‡æª” (MP4)</span>
      <input type="file" id="videoInput" accept="video/*" multiple>
    </div>
    
    <div class="input-group">
      <span class="input-label">2. é¸æ“‡å¤šå€‹éŸ³è¨Šæª” (MP3/WAV)</span>
      <input type="file" id="audioInput" accept="audio/*" multiple>
    </div>

    <button onclick="batchImport()" style="width: 100%; background: #444; color: white;">é–‹å§‹æ™ºæ…§é…å°ä¸¦åŠ å…¥æ¸…å–®</button>
  </div>

  <ul id="playlist"></ul>
</div>

<script>
  // DOM Elements
  const mainVideo = document.getElementById('mainVideo');
  const extAudio = document.getElementById('extAudio');
  const playBtn = document.getElementById('playBtn');
  const vocalBtn = document.getElementById('vocalBtn');
  const statusText = document.getElementById('status-text');
  const playlistEl = document.getElementById('playlist');
  const videoInput = document.getElementById('videoInput');
  const audioInput = document.getElementById('audioInput');

  // State
  let playlist = [];
  let currentIndex = -1;
  let isPlaying = false;
  let isVocalRemove = false;
  let syncInterval;

  // AudioContext (å»äººè²ç”¨)
  let audioCtx, sourceNode, splitter, merger, inverter;

  function initAudio() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  function setupAudioRouting() {
    initAudio();
    // æ¯æ¬¡åˆ‡æ­Œæˆ–é–‹é—œå»äººè²æ™‚é‡æ–°è·¯ç”±
    if (sourceNode) sourceNode.disconnect();
    else sourceNode = audioCtx.createMediaElementSource(extAudio);

    // å…ˆæ–·é–‹æ‰€æœ‰èˆŠé€£æ¥ (é‡ç½®)
    // æ³¨æ„ï¼šå¦‚æœä¸é‡ç½® graph æœ‰æ™‚æœƒæœ‰é›œéŸ³ï¼Œä½†ç°¡å–®å¯¦ä½œé€šå¸¸ç›´æ¥é‡é€£
    
    if (isVocalRemove) {
      if (!splitter) splitter = audioCtx.createChannelSplitter(2);
      if (!merger) merger = audioCtx.createChannelMerger(2);
      if (!inverter) { inverter = audioCtx.createGain(); inverter.gain.value = -1; }

      sourceNode.connect(splitter);
      // L-R æ¼”ç®—æ³•
      splitter.connect(merger, 0, 0); // L -> L
      splitter.connect(inverter, 1);  // R -> Inverter
      inverter.connect(merger, 0, 0); // -R -> L
      
      // é›™å–®è²é“è¼¸å‡º
      splitter.connect(merger, 0, 1);
      inverter.connect(merger, 0, 1);

      merger.connect(audioCtx.destination);
    } else {
      sourceNode.connect(audioCtx.destination);
    }
  }

  // --- 1. æ’­æ”¾æ ¸å¿ƒèˆ‡å¿«é€²ä¿®æ­£ ---
  
  // æ’­æ”¾æŒ‰éˆ•é‚è¼¯
  playBtn.addEventListener('click', () => {
    if (currentIndex === -1) return alert("æ¸…å–®æ˜¯ç©ºçš„ï¼");
    if (mainVideo.paused) {
      mainVideo.play();
    } else {
      mainVideo.pause();
    }
  });

  // ç›£è½å½±ç‰‡æ’­æ”¾äº‹ä»¶ (é©…å‹• Audio)
  mainVideo.addEventListener('play', () => {
    initAudio();
    extAudio.play();
    isPlaying = true;
    playBtn.textContent = "â¸ æš«åœ";
    startSync();
    setupAudioRouting(); // ç¢ºä¿è²éŸ³æœ‰å‡ºä¾†
  });

  mainVideo.addEventListener('pause', () => {
    extAudio.pause();
    isPlaying = false;
    playBtn.textContent = "â–¶ æ’­æ”¾";
    stopSync();
  });

  // *** ä¿®æ­£å¿«é€²/å¾Œé€€çš„æ ¸å¿ƒ ***
  // ç•¶ä½¿ç”¨è€…æ‹–å‹•é€²åº¦æ¢æ™‚ ('seeking'), æš«åœåŒæ­¥æª¢æŸ¥
  // ç•¶æ‹–å‹•çµæŸ ('seeked'), å¼·åˆ¶åŒæ­¥éŸ³è¨Šä½ç½®
  mainVideo.addEventListener('seeking', () => {
    // æ‹–å‹•ä¸­ä¸ä¸€å®šè¦æš«åœè²éŸ³ï¼Œä½†æš«åœæœƒæ¯”è¼ƒä¹¾æ·¨
    // extAudio.pause(); 
  });

  mainVideo.addEventListener('seeked', () => {
    // æ‹–å‹•çµæŸï¼ŒæŠŠè²éŸ³æ‹‰åˆ°è·Ÿç•«é¢ä¸€æ¨£çš„æ™‚é–“
    extAudio.currentTime = mainVideo.currentTime;
    // å¦‚æœå½±ç‰‡æ˜¯æ’­æ”¾ä¸­ï¼Œç¢ºä¿è²éŸ³ä¹Ÿç¹¼çºŒæ’­
    if (!mainVideo.paused) {
      extAudio.play();
    }
  });

  // åŒæ­¥æ ¡æ­£ (è™•ç†äº›å¾®èª¤å·®)
  function startSync() {
    stopSync();
    syncInterval = setInterval(() => {
      if (mainVideo.paused) return;
      const diff = Math.abs(mainVideo.currentTime - extAudio.currentTime);
      // èª¤å·®è¶…é 0.2 ç§’æ‰æ ¡æ­£ï¼Œé¿å…é »ç¹è·³å‹•
      if (diff > 0.2) {
        extAudio.currentTime = mainVideo.currentTime;
      }
    }, 500);
  }

  function stopSync() {
    if (syncInterval) clearInterval(syncInterval);
  }

  // --- 2. æ‰¹æ¬¡åŒ¯å…¥é‚è¼¯ ---

  function getFileName(file) {
    // ç§»é™¤å‰¯æª”åï¼Œåªç•™ä¸»æª”å (e.g. "Song.mp4" -> "Song")
    return file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
  }

  function batchImport() {
    const vFiles = Array.from(videoInput.files);
    const aFiles = Array.from(audioInput.files);

    if (vFiles.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡å½±ç‰‡æª”ï¼");

    // å»ºç«‹éŸ³æª”å°ç…§è¡¨ (Map: ä¸»æª”å -> Fileç‰©ä»¶)
    const audioMap = new Map();
    aFiles.forEach(f => audioMap.set(getFileName(f), f));

    let addedCount = 0;

    vFiles.forEach(vFile => {
      const baseName = getFileName(vFile);
      const matchedAudio = audioMap.get(baseName);
      
      // å¦‚æœæœ‰é…å°åˆ°éŸ³æª”ï¼Œå°±ç”¨è©²éŸ³æª”ï¼›å¦‚æœæ²’æœ‰ï¼Œå°±ç”¨å½±ç‰‡æœ¬èº«ç•¶éŸ³æª”(åŸéŸ³)
      const audioSource = matchedAudio ? matchedAudio : vFile;
      const isMatch = !!matchedAudio;

      playlist.push({
        title: baseName,
        videoUrl: URL.createObjectURL(vFile),
        audioUrl: URL.createObjectURL(audioSource),
        isMatch: isMatch
      });
      addedCount++;
    });

    renderPlaylist();
    
    // æ¸…ç©ºè¼¸å…¥æ¡†
    videoInput.value = '';
    audioInput.value = '';

    if (addedCount > 0) {
      alert(`æˆåŠŸåŠ å…¥ ${addedCount} é¦–æ­Œï¼`);
      if (currentIndex === -1) playIndex(0);
    }
  }

  // --- 3. æ¸…å–®èˆ‡UI ---

  function renderPlaylist() {
    playlistEl.innerHTML = '';
    playlist.forEach((item, idx) => {
      const li = document.createElement('li');
      li.className = `playlist-item ${idx === currentIndex ? 'playing' : ''}`;
      
      const matchText = item.isMatch 
        ? `<span class="item-match-info match-success">â˜… æ™ºæ…§é…å°æˆåŠŸ (ç¨ç«‹éŸ³è»Œ)</span>`
        : `<span class="item-match-info match-none">åŸéŸ³æ’­æ”¾ (ç„¡å¤–éƒ¨éŸ³è»Œ)</span>`;

      li.innerHTML = `
        <div class="item-info" onclick="playIndex(${idx})">
          <span class="item-title">${idx+1}. ${item.title}</span>
          ${matchText}
        </div>
        <button class="btn-del" onclick="delIndex(${idx})">Ã—</button>
      `;
      playlistEl.appendChild(li);
    });
  }

  function playIndex(idx) {
    if (idx < 0 || idx >= playlist.length) return;
    
    currentIndex = idx;
    const item = playlist[idx];

    mainVideo.src = item.videoUrl;
    extAudio.src = item.audioUrl;
    
    // æ°¸é éœéŸ³å½±ç‰‡ï¼Œçµ±ä¸€ç”± extAudio ç™¼è²
    // é€™æ¨£å»äººè²é‚è¼¯æ‰èƒ½çµ±ä¸€
    mainVideo.muted = true;

    statusText.textContent = `æ­£åœ¨æ’­æ”¾: ${item.title}`;
    
    // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
    mainVideo.play().then(() => {
      isPlaying = true;
      playBtn.textContent = "â¸ æš«åœ";
    }).catch(e => console.log(e));
    
    renderPlaylist();
  }

  function delIndex(idx) {
    playlist.splice(idx, 1);
    if (currentIndex === idx) {
      mainVideo.pause();
      currentIndex = -1;
      statusText.textContent = "åœæ­¢æ’­æ”¾";
    } else if (currentIndex > idx) {
      currentIndex--;
    }
    renderPlaylist();
  }

  // å»äººè²æŒ‰éˆ•
  vocalBtn.addEventListener('click', () => {
    isVocalRemove = !isVocalRemove;
    vocalBtn.classList.toggle('active');
    if (currentIndex !== -1) setupAudioRouting();
  });

  // æ‹–æ›³æ’åº
  new Sortable(playlistEl, {
    animation: 150,
    onEnd: (evt) => {
      const item = playlist.splice(evt.oldIndex, 1)[0];
      playlist.splice(evt.newIndex, 0, item);
      if (currentIndex === evt.oldIndex) currentIndex = evt.newIndex;
      renderPlaylist();
    }
  });
  
  // è‡ªå‹•ä¸‹ä¸€é¦–
  mainVideo.addEventListener('ended', () => {
    if (currentIndex < playlist.length - 1) playIndex(currentIndex + 1);
  });

</script>
</body>
</html>
